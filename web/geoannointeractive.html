<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Annotate Coordinates</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://unpkg.com/chota@latest">
        <script src="js/leafletHelper.js"></script>
    </head>
    <body>
        <p> Supply an existing object via its URI. </p>
        <p> Then supply a latitude and longitude. </p>
        <p> Then Submit. </p>
        <label>Object URI</label><input id="objURI" type="text" />
        <h4 title="Use the map below to pan around.  Click to be given the option to use coordinates, or enter coordinates manually.">Map Information</h4>
        <div title="Use the map below to pan around.  Click to be given the option to use coordinates, or enter coordinates manually." id="leafletPreview" class="col"></div>
        <input type="hidden" deer-key="geometry" value="{}">
        <div class="grouped">
            <label>Latitude</label>
            <input id="leafLat" step=".000000001" type="number">

            <label>Longitude</label>
            <input id="leafLong" step=".000000001" type="number">
        </div>
        <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>
        <script src="https://cdn.osmbuildings.org/classic/0.2.2b/OSMBuildings-Leaflet.js"></script>

        <script>
            var previewMap = L.map('leafletPreview').setView([38.628009, -90.201101], 16)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(previewMap);
            var osmb = new OSMBuildings(previewMap).load('https://{s}.data.osmbuildings.org/0.2/anonymous/tile/{z}/{x}/{y}.json')

            leafLat.oninput = updateGeometry
            leafLong.oninput = updateGeometry

            function updateGeometry(event, clickedLat, clickedLong) {
                event.preventDefault()
                if (clickedLong > -180) {
                    leafLat.value = parseInt(clickedLat * 1000000) / 1000000
                    leafLong.value = parseInt(clickedLong * 1000000) / 1000000
                }
                let geometryInput = document.querySelector("input[deer-key='geometry']")
                let lat = parseInt(leafLat.value * 1000000) / 1000000
                let long = parseInt(leafLong.value * 1000000) / 1000000
                if (lat && long) {
                    previewMap.setView([lat, long], 18)
                    let geometry = {
                        type: "Point",
                        coordinates: [long, lat]
                    }
                    geometryInput.value = JSON.stringify(geometry)
                }
            }
            previewMap.on('click', e => L.popup().setLatLng(e.latlng).setContent(`<div>${e.latlng.toString()}<br><button class="tag is-small text-primary bd-primary" onclick="updateGeometry(event,${e.latlng.lat},${e.latlng.lng});">Use These</button></div>`).openOn(previewMap))
        </script>
        
        
        
        <input type="button" onclick="submitAnno(event)"
    </body>
    <script>
        
        let geo = {
            "properties": {
                "label":"Unknown",
                "description":"Unknown"
            },
            "geometry": {
                "type": "Point",
                "coordinates": [] //let latlang = [38.6360699, -90.2348349] SLU
            },
            "type": "Feature"
        }
        
        function updateGeometry(event, clickedLat, clickedLong) {
            event.preventDefault()
            let lat = parseInt(lat.value * 1000000) / 1000000
            let long = parseInt(long.value * 1000000) / 1000000
            if (lat && long) {
                previewMap.setView([lat, long], 18)
                let geometry = {
                    type: "Point",
                    coordinates: [long, lat]
                }
                geo.geometry = geometry
            }
        }
        
        document.getElementById("lat").oninput = updateGeometry
        document.getElementById("long").oninput = updateGeometry
        
        async function provideTarget(event){
            let target = document.getElementById('objURI').value
            let targetObjDescription = "Unknown"
            let targetObjLabel = "Unknown"
            let targetObj = await fetch(target)
                .then(resp => resp.json())
                .catch(err => {return null})
            if(targetObj){
                targetObjDescription = targetObj.description ? targetObj.description : "Unknown"
                targetObjLabel = targetObj.label ? targetObj.label : targetObj.name ? targetObj.name : "Unknown"
                geo.properties = {"type":"Feature","properties":{"label":targetObjLabel, "description":targetObjDescription}}
            }
            else{
                alert("This target cannot be resolved.  The annotation will be applied but certain information about the target will be unknown.")
            }
        } 
        
        async function submitAnno(event){
            let targetURL = document.getElementById('objURI').value
            let demoAnno = 
            {
                "type":"Annotation",
                "@context":"http://www.w3.org/ns/anno.jsonld",
                "target":targetURL,   
                "body":geo,
                "madeByUser" : "BryGuy",
                "madeByApp"  : "MapDemo"
            }
            
            let createdObj = await fetch(leafy.URLS.CREATE, {
                method: "POST",
                mode: "cors",
                body: JSON.stringify(demoAnno)
            })
            .then(response => response.json())
            .then(newObj => {return newObj.new_obj_state})
            alert("A coordinate annotation was created that targets "+targetURL)
        }
        

    </script>
</html>
